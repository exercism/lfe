#!/usr/bin/env bash

set -euo pipefail

original_dir=$PWD

run_test() {
  (
    cleanup() {
        if [[ -f "$stub_backup" && -f "$stub_file" ]]; then
            cp "$stub_backup" "$stub_file"
        fi
    }

    trap cleanup EXIT

    exercise_dir="${1%/}"
    cd "$exercise_dir"

    slug="${1%/}"
    slug="${slug##*/}"
    echo "Checking $slug"

    # special case where the slug is different inside the folder
    if [[ "$slug" = "binary" ]]; then
        slug="binary-string"
    fi

    example_file=".meta/example.lfe"
    stub_file="src/$slug.lfe"
    stub_backup="src/$slug.bak"

    cp "$stub_file" "$stub_backup"
    cp "$example_file" "$stub_file"

    if ! make test; then
      echo "❌ $slug tests failed"
      exit 1
    fi

    echo "✅ $slug tests passed"
  )
}

if [[ -d "./exercises/concept" ]]; then
    echo "Checking concept exercises..."
    for concept_exercise_dir in ./exercises/concept/*/; do
        if [[ -d $concept_exercise_dir ]]; then
            slug=$(basename "${practice_exercise_dir}")
            run_test "$concept_exercise_dir"
        fi
    done
else
    echo "No concept exercises found. Skipping..."
fi


echo "Checking practice exercises..."

practice_exercises=$(jq -r '
  .exercises.practice |
  map(select((.status != "deprecated"))) |
  sort_by(.slug)[] |
  .slug
' config.json)

for practice_exercise in $practice_exercises; do
    if [[ -d "./exercises/practice/$practice_exercise" ]]; then
        run_test "./exercises/practice/$practice_exercise"
    else
        echo "Folder not found for $practice_exercise"
        exit 1
    fi
done
